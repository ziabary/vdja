<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ØªØ±Ø¬Ù…Ù‡ - Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒ</title>
    <link rel="stylesheet" href="css/bootstrap.rtl.min.css" />
    <link rel="stylesheet" href="fonts/IranSansX/fontiran.css" />
    <script src="js/marked.min.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .translate-box {
        min-height: 200px;
        font-size: 1.2rem;
      }
      .lang-select {
        max-width: 180px;
      }
      .swap-btn {
        font-size: 1.5rem;
        cursor: pointer;
        color: #0d6efd;
      }
      .output-text {
        white-space: pre-wrap;
      }
      .streaming {
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-light bg-white shadow-sm">
      <div class="container">
        <img src="/img/defard.png" alt="Ù„ÙˆÚ¯Ùˆ"/>
        <span class="navbar-brand mx-auto h4 mb-0">ØªØ±Ø¬Ù…Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
        <a href="/" class="btn btn-outline-primary">â† Ø¨Ø§Ø²Ú¯Ø´Øª</a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="card shadow">
        <div class="card-body p-4">
          <!-- Language selection row - moved above boxes -->
          <div class="row g-3 mb-4 align-items-center">
            <div class="col-lg-6 text-start">
              <select id="sourceLang" class="form-select lang-select">
                <option value="auto">ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±</option>
                <!-- filled by JS -->
              </select>
            </div>

            <div class="col-auto" style="display: none">
              <button id="swapBtn" class="swap-btn btn btn-link px-4">â†”</button>
            </div>

            <div class="col-lg-6 text-end">
              <select id="targetLang" class="form-select lang-select">
                <!-- filled by JS -->
              </select>
            </div>
          </div>

          <!-- Input and output boxes in same row with equal height -->
          <div class="row g-4" style="min-height: 300px">
            <div class="col-lg-6 d-flex flex-column">
              <textarea
                id="inputText"
                class="form-control translate-box flex-grow-1"
                placeholder="Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ ÛŒØ§ Ø¨Ú†Ø³Ø¨Ø§Ù†ÛŒØ¯..."
              ></textarea>
              <div class="mt-3 d-flex gap-3 align-items-center">
                <input
                  type="file"
                  id="fileInput"
                  class="form-control"
                  accept=".txt,.docx,.pdf"
                />
                <div class="flex-grow-1">
                  <div class="progress" id="progressBar" style="display: none">
                    <div
                      class="progress-bar progress-bar-striped progress-bar-animated"
                      role="progressbar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
              <div class="mt-2 text-end">
                <small class="text-muted fa-num" id="charCount"
                  >0 Ú©Ø§Ø±Ø§Ú©ØªØ±</small
                >
              </div>
            </div>

            <div class="col-lg-6 d-flex flex-column">
              <div
                id="outputText"
                class="form-control translate-box bg-light output-text flex-grow-1"
                contenteditable="false"
              ></div>
              <div
                class="mt-3 text-end d-flex gap-3 justify-content-end align-items-center"
              >
                <button id="translateBtn" class="btn btn-primary px-5">
                  ØªØ±Ø¬Ù…Ù‡
                </button>
                <button id="copyBtn" class="btn btn-outline-secondary px-4">
                  Ú©Ù¾ÛŒ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <div class="alert alert-info small mt-4" role="alert">
          <p class="mb-3">
            <span class="me-2">â„¹ï¸</span>
            <strong>ØªÙˆØ¬Ù‡:</strong> Ø§ÛŒÙ† Ù…ØªØ±Ø¬Ù… Ø¨Ù‡ ØµÙˆØ±Øª ØºÛŒØ± Ø¨Ø±Ø®Ø· Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ
            Ø²Ø¨Ø§Ù†ÛŒ Ø¨Ø²Ø±Ú¯ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± ØªØ±Ø¬Ù…Ù‡
            Ù…ØªÙˆÙ† ØªØ®ØµØµÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ±Ø¬Ù…Ù‡ ØªØ®ØµØµÛŒØŒ Ø§Ù…Ú©Ø§Ù†
            ØªÙˆØ³Ø¹Ù‡ Ù…ØªØ±Ø¬Ù… ÙˆÛŒÚ˜Ù‡ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ø¯Ø§Ø¯Ú¯Ø§Ù† ØªØ®ØµØµÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.
          </p>
          <p class="mb-3">
            <span class="me-2">ğŸ“„</span>
            ØªÙˆØ¬Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ PDF (Ø¨Ø§Ù„Ø§Ø®Øµ ÙØ§Ø±Ø³ÛŒ) Ù‡Ù†ÙˆØ² Ø±Ø§Ù‡â€ŒÚ©Ø§Ø±
            Ù‚Ø·Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ Ùˆ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø² Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
            Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
          </p>
          <p class="mb-0">
            <span class="me-2">âš ï¸</span>
            Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ±Ø¬Ù…Ù‡ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†
            Ø§ØµÙ„ÛŒ Ùˆ ØªØ±Ø¬Ù…Ù‡ Ø¢Ù† Ø¯Ø± Ø³Ø±ÙˆØ± Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù‡Ø³ØªÙ†Ø¯Ø› Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø³Ø¨Ø¨ Ù„Ø·ÙØ§Ù‹ Ø§Ø²
            Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙˆÙ† Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ´Ø¯Ù‡ ÛŒØ§ Ø­Ø³Ø§Ø³ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ ÙØ±Ù…Ø§ÛŒÛŒØ¯.
          </p>
        </div>
      </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
      const languages = {
        auto: "ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±",
        ar: "Ø¹Ø±Ø¨ÛŒ",
        bg: "Ø¨Ù„ØºØ§Ø±ÛŒ",
        cs: "Ú†Ú©ÛŒ",
        da: "Ø¯Ø§Ù†Ù…Ø§Ø±Ú©ÛŒ",
        de: "Ø¢Ù„Ù…Ø§Ù†ÛŒ",
        el: "ÛŒÙˆÙ†Ø§Ù†ÛŒ",
        en: "Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ",
        es: "Ø§Ø³Ù¾Ø§Ù†ÛŒØ§ÛŒÛŒ",
        fa: "ÙØ§Ø±Ø³ÛŒ",
        fi: "ÙÙ†Ù„Ø§Ù†Ø¯ÛŒ",
        fr: "ÙØ±Ø§Ù†Ø³ÙˆÛŒ",
        hi: "Ù‡Ù†Ø¯ÛŒ",
        id: "Ø§Ù†Ø¯ÙˆÙ†Ø²ÛŒØ§ÛŒÛŒ",
        it: "Ø§ÛŒØªØ§Ù„ÛŒØ§ÛŒÛŒ",
        ja: "Ú˜Ø§Ù¾Ù†ÛŒ",
        ko: "Ú©Ø±Ù‡â€ŒØ§ÛŒ",
        nl: "Ù‡Ù„Ù†Ø¯ÛŒ",
        pl: "Ù„Ù‡Ø³ØªØ§Ù†ÛŒ",
        pt: "Ù¾Ø±ØªØºØ§Ù„ÛŒ",
        ru: "Ø±ÙˆØ³ÛŒ",
        tr: "ØªØ±Ú©ÛŒ",
        uk: "Ø§ÙˆÚ©Ø±Ø§ÛŒÙ†ÛŒ",
        zh: "Ú†ÛŒÙ†ÛŒ",
      };

      const sourceSelect = document.getElementById("sourceLang");
      const targetSelect = document.getElementById("targetLang");
      const swapBtn = document.getElementById("swapBtn");
      const inputText = document.getElementById("inputText");
      const outputText = document.getElementById("outputText");
      const translateBtn = document.getElementById("translateBtn");
      const copyBtn = document.getElementById("copyBtn");
      const fileInput = document.getElementById("fileInput");
      const progressBar = document
        .getElementById("progressBar")
        .querySelector(".progress-bar");
      const charCount = document.getElementById("charCount");

      Object.entries(languages).forEach(([code, name]) => {
        if (code !== "auto") {
          const opt1 = new Option(name, code);
          const opt2 = new Option(name, code);
          sourceSelect.add(opt1);
          targetSelect.add(opt2);
        }
      });
      targetSelect.value = "fa";

      sourceSelect.addEventListener("change", () => {
        if (
          sourceSelect.value === targetSelect.value &&
          sourceSelect.value !== "auto"
        ) {
          targetSelect.value = "fa";
        }
      });
      targetSelect.addEventListener("change", () => {
        if (
          sourceSelect.value === targetSelect.value &&
          sourceSelect.value !== "auto"
        ) {
          sourceSelect.value = "en";
        }
      });

      inputText.addEventListener("input", () => {
        updateCharCount();
      });

      copyBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(outputText.textContent);
      });

      translateBtn.addEventListener("click", async () => {
        const text = inputText.value.trim();
        if (!text) return;

        translateBtn.disabled = true;
        translateBtn.textContent = "Ø¯Ø± Ø­Ø§Ù„ ØªØ±Ø¬Ù…Ù‡...";
        outputText.textContent = "";
        outputText.classList.add("streaming");

        try {
          const res = await fetch("/api/translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              text,
              source_lang:
                sourceSelect.value === "auto"
                  ? "auto"
                  : languages[sourceSelect.value],
              target_lang: languages[targetSelect.value],
            }),
          });

          if (!res.ok) throw new Error("Ø®Ø·Ø§");

          const reader = res.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk
              .split("\n")
              .filter((line) => line.startsWith("data: "));

            for (const line of lines) {
              if (line === "data: [DONE]") continue;
              try {
                const json = JSON.parse(line.slice(6));
                const token = json.choices[0].delta.content || "";
                outputText.textContent += token;
              } catch (e) {}
            }
          }
        } catch (err) {
          outputText.textContent = "Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø¬Ù…Ù‡. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.";
        } finally {
          translateBtn.disabled = false;
          translateBtn.textContent = "ØªØ±Ø¬Ù…Ù‡";
          outputText.classList.remove("streaming");
        }
      });
      const RTL_LANGS = ["fa", "ar", "he"];

      fileInput.addEventListener("change", async () => {
        const file = fileInput.files[0];
        if (!file) return;

        // Client-side type check
        const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'application/msword'];
        if (!allowedTypes.includes(file.type)) {
          showError("Ù†ÙˆØ¹ ÙØ§ÛŒÙ„ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª (ÙÙ‚Ø· PDF, DOCX, TXT)");
          fileInput.value = "";
          return;
        }

        progressBar.parentElement.style.display = "block";
        progressBar.style.width = "0%";
        inputText.value = "";
        outputText.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„...";

        try {
          const formData = new FormData();
          formData.append("file", file);

          const res = await fetch("/api/upload-text", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„");

          const data = await res.json();
          const fullText = data.text;
          if (fullText.length > 10000) {  // assuming same limit
            toast("Ù…ØªÙ† ÙØ§ÛŒÙ„ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª Ùˆ Ø¨Ø±ÛŒØ¯Ù‡ Ø´Ø¯.", "warning");
          }
          inputText.value = fullText.slice(0, 10000);

          progressBar.style.width = "100%";
          setTimeout(() => {
            progressBar.parentElement.style.display = "none";
            progressBar.style.width = "0%";
          }, 600);

          outputText.textContent = "";
          updateCharCount();
        } catch (err) {
          showError(
            err.message ||
              "ÙØ§ÛŒÙ„ Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù†ÛŒØ³Øª. ÙÙ‚Ø· PDFØŒ DOCX Ùˆ TXT Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯."
          );
          progressBar.parentElement.style.display = "none";
        } finally {
          fileInput.value = "";
        }
      });

      function updateCharCount() {
        charCount.textContent = `${inputText.value.length} Ú©Ø§Ø±Ø§Ú©ØªØ±`;
      }

      function updateDirection() {
        const targetCode = targetSelect.value;
        const isRTL = RTL_LANGS.includes(targetCode);

        // Output box direction
        outputText.style.direction = isRTL ? "rtl" : "ltr";
        outputText.style.textAlign = isRTL ? "right" : "left";

        // Input box: follow target if source is auto, otherwise follow source
        let inputDir = "ltr";
        let inputAlign = "left";
        if (sourceSelect.value === "auto") {
          inputDir = isRTL ? "rtl" : "ltr";
          inputAlign = isRTL ? "right" : "left";
        } else {
          const sourceIsRTL = RTL_LANGS.includes(sourceSelect.value);
          inputDir = sourceIsRTL ? "rtl" : "ltr";
          inputAlign = sourceIsRTL ? "right" : "left";
        }

        inputText.style.direction = inputDir;
        inputText.style.textAlign = inputAlign;
      }

      // Update on load and on language change
      targetSelect.addEventListener("change", updateDirection);
      sourceSelect.addEventListener("change", updateDirection);
      window.addEventListener("load", updateDirection);
    </script>
  </body>
</html>
