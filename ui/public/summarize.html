<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ุฎูุงุตูโุณุงุฒ - ุฏุณุชุงุฑ ููุดููุฏ ูุงุฑุณ</title>
    <link rel="stylesheet" href="css/bootstrap.rtl.min.css" />
    <link rel="stylesheet" href="fonts/IranSansX/fontiran.css" />
    <script src="js/marked.min.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .translate-box {
        min-height: 250px;
        font-size: 1.2rem;
      }
      .output-text {
        white-space: pre-wrap;
      }
      .progress {
        height: 8px;
      }
      #outputText {
        overflow-y: auto;
        line-height: 1.6;
      }
      #outputText strong {
        font-weight: bold;
      }
      #outputText em {
        font-style: italic;
      }
      #outputText ul,
      #outputText ol {
        padding-right: 20px;
      }
      #outputText li {
        margin-bottom: 0.5rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-light bg-white shadow-sm">
      <div class="container">
        <img src="/img/defard.png" alt="ููฺฏู" />
        <span class="navbar-brand mx-auto h4 mb-0">ุฎูุงุตูโุณุงุฒ ููุดููุฏ</span>
        <a href="/" class="btn btn-outline-primary">โ ุจุงุฒฺฏุดุช</a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="card shadow">
        <div class="card-body p-4">
          <div class="row g-4" style="min-height: 400px">
            <!-- Input column -->
            <div class="col-lg-6 d-flex flex-column">
              <label class="form-label fw-bold mb-3"
                >ูุชู ุง ูุงู ุจุฑุง ุฎูุงุตูโุณุงุฒ</label
              >

              <textarea
                id="inputText"
                class="form-control translate-box flex-grow-1 mb-3"
                placeholder="ูุชู ุฎูุฏ ุฑุง ุงูุฌุง ุจููุณุฏ ุง ูุงู ุฑุง ุขูพููุฏ ฺฉูุฏ..."
              ></textarea>

              <div class="d-flex gap-3 align-items-center">
                <input
                  title="file"
                  type="file"
                  id="fileInput"
                  class="form-control"
                  accept=".txt,.doc,.docx,.pdf"
                />
                <div class="flex-grow-1">
                  <div class="progress" id="progressBar" style="display: none">
                    <div
                      class="progress-bar"
                      role="progressbar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ฺฉููุงุช ุฏุฑ ุฎูุงุตู</label>
                <input
                  type="number"
                  title="maxWords"
                  id="maxWords"
                  class="form-control fa-num ltr"
                  value="200"
                  min="50"
                  max="1000"
                />
              </div>
              <div class="mt-3 form-check text-end">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="forcePersian"
                  checked
                />
                <label class="form-check-label" for="forcePersian">
                  ุฎุฑูุฌ ุจู ูุงุฑุณ (ุฏุฑ ุตูุฑุช ุบุฑูุงุฑุณ ุจูุฏู ูุชู ูุฑูุฏ)
                </label>
              </div>
            </div>

            <!-- Output column -->
            <div class="col-lg-6 d-flex flex-column">
              <label class="form-label fw-bold mb-3">ุฎูุงุตู</label>
              <div
                id="outputText"
                class="form-control translate-box bg-light flex-grow-1 p-4 overflow-auto"
                style="line-height: 1.7"
              ></div>
              <div
                class="mt-3 text-end d-flex gap-3 justify-content-end align-items-center flex-wrap"
              >
                <button
                  id="copyMarkdownBtn"
                  class="btn btn-outline-secondary px-4"
                >
                  ฺฉูพ Markdown
                </button>
                <button
                  id="copyPlainBtn"
                  class="btn btn-outline-secondary px-4"
                >
                  ฺฉูพ ุจุฑุง Word
                </button>
                <button id="summarizeBtn" class="btn btn-primary px-5">
                  ุฎูุงุตู ฺฉู
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer bg-transparent border-0 pt-0">
        <div class="alert alert-info small mt-4" role="alert">
          <p class="mb-3">
            <span class="me-2">โน๏ธ</span>
            ุงู ุฎูุงุตูโุณุงุฒ ูโุชูุงูุฏ ูุชูโูุง ู ูุงูโูุง ุฑุง ุฎูุงูุฏู ู ุขูโูุง ุฑุง ุจุง ฺฉูฺฉ
            ูุฏู ุฒุจุงู ุจุฒุฑฺฏ ุจูููโุณุงุฒโุดุฏู ุจุฑุง ุฒุจุงู ูุงุฑุณ ุฎูุงุตู ฺฉูุฏ. ูุณุฎู ูุนู
            ุฏุงุฑุง ูุญุฏูุฏุช ุญุฌู ูุชู ูุฑูุฏ ุจู ูุฒุงู ุญุฏุงฺฉุซุฑ ฑฐ ูุฒุงุฑ ฺฉุงุฑุงฺฉุชุฑ ุจูุฏู ู
            ุงูุจุงู ูุชู ุฑุง ููโุฎูุงูุฏ.
          </p>
          <p class="mb-3">
            <span class="me-2">๐</span>
            ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุจุฑุง ูุงูโูุง PDF (ุจุงูุงุฎุต ูุงุฑุณ) ูููุฒ ุฑุงูโฺฉุงุฑ
            ูุทุน ุจุฑุง ุงุณุชุฎุฑุงุฌ ูุญุชูุง ูุฌูุฏ ูุฏุงุฑุฏ ู ุณุงูุงูู ุงุฒ ุณุฑูุณโูุง ุงุณุชุงูุฏุงุฑุฏ
            ุงุณุชุฎุฑุงุฌ ูุชู ุงุณุชูุงุฏู ูโฺฉูุฏ
          </p>
          <p class="mb-0">
            <span class="me-2">โ๏ธ</span>
            ูุงูโูุง ุงุฑุงุฆูโุดุฏู ุจู ุฎูุงุตูโุณุงุฒ ุฏุฑ ุฌุง ุฐุฎุฑู ููโุดููุฏ ู ุจูุงูุงุตูู ูพุณ
            ุงุฒ ุฎูุงุตูโุณุงุฒ ุญุฐู ูโุดููุฏ. ุจุง ุงู ุญุงู ุจุง ุชูุฌู ุจู ุชุญุช ุดุจฺฉู ุจูุฏู
            ุณุงูุงููุ ุงุฒ ุงุฑุณุงู ูุงูโูุง ุทุจููโุจูุฏโุดุฏู ู ุญุณุงุณ ุฎูุฏุฏุงุฑ ุดูุฏ.
          </p>
        </div>
      </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
      const inputText = document.getElementById("inputText");
      const fileInput = document.getElementById("fileInput");
      const progressBar = document.getElementById("progressBar");
      const progressFill = progressBar.querySelector(".progress-bar");
      const maxWords = document.getElementById("maxWords");
      const outputText = document.getElementById("outputText");
      const summarizeBtn = document.getElementById("summarizeBtn");
      const copyMarkdownBtn = document.getElementById("copyMarkdownBtn");
      const copyPlainBtn = document.getElementById("copyPlainBtn");
      const forcePersian = document.getElementById("forcePersian");
      let fullMarkdown = "";

      // File upload with progress
      fileInput.addEventListener("change", async () => {
        const file = fileInput.files[0];
        if (!file) return;

        if (file.size > 10 * 1024 * 1024) {
          showError("ุญุฌู ูุงู ุจุด ุงุฒ ฑฐ ูฺฏุงุจุงุช ุงุณุช");
          fileInput.value = "";
          return;
        }

        // Client-side type check
        const allowedTypes = [
          "application/pdf",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          "text/plain",
          "application/msword",
        ];
        if (!allowedTypes.includes(file.type)) {
          showError("ููุน ูุงู ูุฌุงุฒ ูุณุช (ููุท PDF, DOCX, TXT)");
          fileInput.value = "";
          return;
        }

        const originalText = inputText.value.trim(); // for warning
        progressBar.style.display = "block";
        progressFill.style.width = "0%";

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch("/api/upload-text", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "ุฎุทุง ุฏุฑ ุฎูุงูุฏู ูุงู");
          }

          const data = await res.json();
          const fullText = data.text;
          if (fullText.length > 10000) {
            toast(
              "ูุชู ูุงู ุจุด ุงุฒ ฑฐฐฐฐ ฺฉุงุฑุงฺฉุชุฑ ุงุณุช ู ุจุฎุด ุงุถุงู ุจุฑุฏู ุดุฏ.",
              "warning"
            );
          }
          inputText.value = fullText.slice(0, 10000);
          progressFill.style.width = "100%";
          setTimeout(() => {
            progressBar.style.display = "none";
          }, 500);
        } catch (err) {
          showError(
            err.message ||
              "ุฎุทุง ุฏุฑ ุฎูุงูุฏู ูุงู. ุจุฑุง PDFูุง ูุงุฑุณ ูพฺุฏู ููฺฉู ุงุณุช ูุงุฒ ุจู ูพุดโูพุฑุฏุงุฒุด ุจุงุดุฏ."
          );
          progressBar.style.display = "none";
        } finally {
          fileInput.value = "";
        }
      });

      summarizeBtn.addEventListener("click", async () => {
        const text = inputText.value.trim();
        if (!text) {
          showError("ูุทูุงู ูุชู ุง ูุงู ุจุฑุง ุฎูุงุตูโุณุงุฒ ูุงุฑุฏ ฺฉูุฏ.");
          return;
        }

        const words = parseInt(maxWords.value) || 200;
        let attempts = 0;
        const maxAttempts = 3;

        outputText.textContent = "";
        fullMarkdown = "";
        outputText.classList.add("streaming");

        summarizeBtn.disabled = true;
        summarizeBtn.textContent = "ุฏุฑ ุญุงู ุฎูุงุตูโุณุงุฒ...";

        while (attempts < maxAttempts) {
          attempts++;
          try {
            const res = await fetch("/api/summarize", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                text: text.slice(0, 10000),
                max_words: words,
                force_persian: forcePersian.checked,
              }),
            });

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || "ุฎุทุง ุณุฑูุฑ");
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let success = false;

            while (true) {
              const { done, value } = await reader.read();
              if (done) {
                success = true;
                break;
              }

              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk
                .split("\n")
                .filter((l) => l.startsWith("data: "));

              for (const line of lines) {
                if (line === "data: [DONE]") continue;
                try {
                  const json = JSON.parse(line.slice(6));
                  const token = json.choices[0].delta.content || "";
                  fullMarkdown += token;
                  outputText.innerHTML = marked.parse(fullMarkdown);
                  updateOutputDirection(fullMarkdown, outputText);
                  outputText.scrollTop = outputText.scrollHeight;
                } catch (e) {}
              }
            }

            if (success) {
              // ููููุช ฺฉุงูู
              break;
            }
          } catch (err) {
            console.error("ุชูุงุด ูุงูููู ุฎูุงุตูโุณุงุฒ:", err);
            if (attempts < maxAttempts) {
              fullMarkdown = "";
              outputText.innerHTML = "";
              toast(
                `ุงุชุตุงู ูุทุน ุดุฏุ ุชูุงุด ูุฌุฏุฏ ${attempts + 1} ุงุฒ ${maxAttempts}...`,
                "warning"
              );
              await new Promise((resolve) => setTimeout(resolve, 1000));
            } else {
              outputText.textContent =
                "ุฎุทุง ุฏุฑ ุฎูุงุตูโุณุงุฒ ูพุณ ุงุฒ ฺูุฏ ุชูุงุด. ูุทูุงู ุงุชุตุงู ุงูุชุฑูุช ุฎูุฏ ุฑุง ุจุฑุฑุณ ฺฉูุฏ ู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉูุฏ.";
            }
          }
        }

        summarizeBtn.disabled = false;
        summarizeBtn.textContent = "ุฎูุงุตู ฺฉู";
        outputText.classList.remove("streaming");
      });
      copyMarkdownBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(fullMarkdown.trim());
        copyMarkdownBtn.textContent = "ฺฉูพ ุดุฏ!";
        setTimeout(() => (copyMarkdownBtn.textContent = "ฺฉูพ Markdown"), 1500);
      });

      copyPlainBtn.addEventListener("click", () => {
        const temp = document.createElement("div");
        temp.innerHTML = marked.parse(fullMarkdown);
        const plain = temp.textContent || temp.innerText || "";
        navigator.clipboard.writeText(plain.trim());
        copyPlainBtn.textContent = "ฺฉูพ ุดุฏ!";
        setTimeout(() => (copyPlainBtn.textContent = "ฺฉูพ ุจุฑุง Word"), 1500);
      });
    </script>
  </body>
</html>
