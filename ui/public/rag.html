<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ú†Øª Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ - Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ§Ø±Ø³ÛŒ</title>
    <link rel="stylesheet" href="css/bootstrap.rtl.min.css" />
    <link rel="stylesheet" href="css/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="fonts/IranSansX/fontiran.css" />
    <script src="js/marked.min.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .chat-container {
        height: 80vh;
        overflow-y: auto;
      }
      .message {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
      }
      .user-message {
        background: #0d6efd;
        color: white;
        margin-left: 20%;
        text-align: right;
      }
      .bot-message {
        background: #f8f9fa;
        color: #333;
        margin-right: 20%;
        text-align: right;
      }
      .sidebar {
        position: fixed;
        right: 0;
        top: 0;
        width: 350px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        z-index: 1000;
      }
      .main-chat {
        margin-right: 350px;
        padding: 20px;
      }
      .file-item,
      .chat-item {
        cursor: pointer;
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
      }
      .file-item:hover,
      .chat-item:hover {
        background: #f8f9fa;
      }
      .delete-btn {
        font-size: 0.8rem;
        color: #dc3545;
      }
      #uploadInput {
        display: none;
      }
      .rtl {
        direction: rtl;
        text-align: right;
      }
      .ltr {
        direction: ltr;
        text-align: left;
      }
      .logo {
        height: 4rem;
        text-align: center;
      }
      .logo img {
        height: 100%;
      }
      .thinking {
        opacity: 0.8;
        font-style: italic;
      }

      .dots {
        display: inline-block;
        width: 20px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="sidebar p-3">
      <div class="logo">
        <a href="/"><img src="img/defard.png" /></a>
      </div>

      <h5 class="mb-3">Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</h5>
      <div
        id="chatsList"
        class="mb-4"
        style="max-height: calc(100vh / 2 - 8em); overflow: auto"
      ></div>
      <button id="newChatBtn" class="btn btn-primary btn-sm w-100 mb-3">
        Ú†Øª Ø¬Ø¯ÛŒØ¯
      </button>

      <h5 class="mb-3">Ø§Ø³Ù†Ø§Ø¯ Ø´Ù…Ø§</h5>
      <div
        id="filesList"
        class="mb-3"
        style="max-height: calc(100vh / 2 - 8em); overflow: auto"
      ></div>
      <label for="uploadInput" class="btn btn-outline-secondary w-100 mb-3"
        >Ø¢Ù¾Ù„ÙˆØ¯ Ø³Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</label
      >
      <input type="file" id="uploadInput" accept=".pdf,.docx,.txt" multiple />
      <button id="deleteAllFilesBtn" class="btn btn-danger btn-sm w-100 mb-2">
        Ø­Ø°Ù Ù‡Ù…Ù‡ Ø³Ù†Ø¯Ù‡Ø§
      </button>
      <button id="deleteAllChatsBtn" class="btn btn-warning btn-sm w-100">
        Ø­Ø°Ù Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§
      </button>
    </div>

    <!-- Main Chat -->
    <div class="main-chat">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4
          id="currentChatTitle"
          class="clickable-title"
          style="cursor: pointer; display: inline-block"
        >
          Ú†Øª Ø¬Ø¯ÛŒØ¯
        </h4>

        <button id="backToLogin" class="btn btn-outline-secondary">Ø®Ø±ÙˆØ¬</button>
      </div>
      <div
        id="chatContainer"
        class="chat-container border p-3 bg-light rounded"
      ></div>
      <div class="input-group mt-3">
        <input
          type="text"
          id="messageInput"
          class="form-control"
          placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
        />
        <button id="sendBtn" class="btn btn-primary">Ø§Ø±Ø³Ø§Ù„</button>
      </div>
    </div>

    <div class="modal fade" id="logoutModal" tabindex="-1">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ø®Ø±ÙˆØ¬</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <p>Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ</p>
          </div>
          <div class="modal-footer justify-content-center">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Ù„ØºÙˆ
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="sessionStorage.removeItem('user_key'); window.location.href='/login.html'"
            >
              Ø¨Ù„Ù‡ØŒ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="confirmModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ØªØ£ÛŒÛŒØ¯ Ø­Ø°Ù</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p id="confirmText">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Ø®ÛŒØ±
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editTitleModal" tabindex="-1">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ù†ÙˆØ§Ù† Ú†Øª</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              id="newTitleInput"
              class="form-control text-center"
              placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
            />
          </div>
          <div class="modal-footer justify-content-center">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Ù„ØºÙˆ
            </button>
            <button type="button" class="btn btn-primary" id="saveTitleBtn">
              Ø°Ø®ÛŒØ±Ù‡
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
      const userKey = sessionStorage.getItem("user_key");
      if (!userKey || userKey.length < 16) {
        showError("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
        window.location.href = "/login.html";
        throw new Error("No user key");
      }
      let currentChatId = null;
      let chatHistory = [];

      const chatsList = document.getElementById("chatsList");
      const filesList = document.getElementById("filesList");
      const chatContainer = document.getElementById("chatContainer");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const currentChatTitle = document.getElementById("currentChatTitle");
      const newChatBtn = document.getElementById("newChatBtn");
      const uploadInput = document.getElementById("uploadInput");
      const deleteAllFilesBtn = document.getElementById("deleteAllFilesBtn");
      const deleteAllChatsBtn = document.getElementById("deleteAllChatsBtn");
      const backToLogin = document.getElementById("backToLogin");

      const titleCache = new Map();

      if (!userKey || userKey.length < 16) {
        window.location.href = "/login.html";
      }

      function isRTL(text) {
        if (!text || text.length < 1) return false;
        const rtlRegex =
          /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/g;
        const rtlChars = (text.match(rtlRegex) || []).length;
        const totalNonWhitespaceChars = text.replace(/\s/g, "").length;
        if (totalNonWhitespaceChars <= 10 && rtlChars >= 1) return true;
        return rtlChars / totalNonWhitespaceChars >= 0.2;
      }

      function updateDirection(element, text) {
        if (isRTL(text)) {
          element.classList.add("rtl");
          element.classList.remove("ltr");
        } else {
          element.classList.add("ltr");
          element.classList.remove("rtl");
        }
      }

      function appendMessage(role, content) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${
          role === "user" ? "user-message" : "bot-message"
        }`;
        if (role === "user") {
          msgDiv.textContent = content;
        } else {
          msgDiv.innerHTML = marked.parse(
            content.replace(/</g, "&lt;").replace(/>/g, "&gt;")
          );
          updateDirection(msgDiv, content);
        }
        chatContainer.appendChild(msgDiv);
      }

      async function loadChats() {
        const res = await fetch(`/api/rag/chats?user_key=${userKey}`);
        const { chats } = await res.json();
        chatsList.innerHTML = chats
          .map(
            (chat) => `
              <div class="chat-item ${
                currentChatId === chat.chat_id ? "bg-primary text-white" : ""
              }" onclick="loadChat('${chat.chat_id}')">
                ${chat.title} <small class="d-inline-block">${new Date(
              chat.last_message_at
            ).toLocaleDateString("fa-IR")}</small>
                <button class="delete-btn float-start" onclick="deleteChat('${
                  chat.chat_id
                }', event)">Ø­Ø°Ù</button>
              </div>
            `
          )
          .join("");
      }

      async function loadFiles() {
        const res = await fetch(`/api/rag/files?user_key=${userKey}`);
        const { files } = await res.json();
        filesList.innerHTML = files
          .map(
            (file) => `
              <div class="file-item">
                ğŸ“„ ${file.file_name} <small class="d-inline-block">${(
              file.file_size /
              1024 /
              1024
            ).toFixed(1)} MB</small>
                <button class="delete-btn float-start text" onclick="deleteFile('${
                  file.file_id
                }', '${file.file_name}', event)">Ø­Ø°Ù</button>
              </div>
            `
          )
          .join("");
      }

      async function loadChat(chatId) {
        currentChatId = chatId;
        chatHistory = [];
        chatContainer.innerHTML = "";
        currentChatTitle.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ù„ÙˆØ¯...";
        try {
          const res = await fetch(
            `/api/rag/chat/${chatId}/messages?user_key=${userKey}`
          );
          if (!res.ok) {
            toast("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú†Øª", "danger");
            return;
          }
          const { messages } = await res.json();
          chatHistory = messages.map((m) => ({
            role: m.role,
            content: m.content,
          }));
          messages.forEach((m) => appendMessage(m.role, m.content));
          chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (err) {
          console.error(err);
          toast("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·", "danger");
        }
      }

      let titleEditModal = null;
      document.getElementById("currentChatTitle").onclick = () => {
        console.log("clicked");
        if (!currentChatId) return;

        titleEditModal = new bootstrap.Modal(
          document.getElementById("editTitleModal")
        );
        document.getElementById("newTitleInput").value =
          currentChatTitle.textContent.trim();
        titleEditModal.show();
      };

      document
        .getElementById("saveTitleBtn")
        .addEventListener("click", async () => {
          const newTitle = document
            .getElementById("newTitleInput")
            .value.trim();
          if (!newTitle || newTitle === currentChatTitle.textContent.trim()) {
            titleEditModal.hide();
            return;
          }

          const res = await fetch("/api/rag/chat/title", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_key: userKey,
              chat_id: currentChatId,
              title: newTitle,
            }),
          });

          if (res.ok) {
            currentChatTitle.innerHTML =
              newTitle +
              `<small class="text-muted ms-2" style="font-size: 0.5em;">(Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</small>`;
            toast("Ø¹Ù†ÙˆØ§Ù† Ú†Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯", "success");
            loadChats();
          } else {
            toast("Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ø¹Ù†ÙˆØ§Ù†", "danger");
          }
          titleEditModal.hide();
        });

      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        if (!currentChatId) {
          try {
            const res = await fetch("/api/rag/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_key: userKey }),
            });
            if (!res.ok) {
              toast("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ú†Øª Ø¬Ø¯ÛŒØ¯", "danger");
              return;
            }
            const { chat_id } = await res.json();
            currentChatId = chat_id;
            chatHistory = [];
            chatContainer.innerHTML = "";
            currentChatTitle.textContent = "Ú†Øª Ø¬Ø¯ÛŒØ¯";
            loadChats();
          } catch (err) {
            console.error(err);
            toast("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ú†Øª Ø¬Ø¯ÛŒØ¯", "danger");
            return;
          }
        }

        appendMessage("user", message);

        // Ø³Ø§Ø®Øª Ø¨Ø§Ú©Ø³ Ø±Ø¨Ø§Øª Ú©Ù‡ Ø§ÙˆÙ„ Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ù†Ø´ÙˆÙ† Ù…ÛŒâ€ŒØ¯Ù‡
        const botMessageWrapper = document.createElement("div");
        botMessageWrapper.className = "message bot-message";
        botMessageWrapper.id = "botResponseWrapper";

        const botMsg = document.createElement("div");
        botMsg.className = "bot-text";

        // Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯
        botMsg.innerHTML = `
          <span class="thinking">Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†</span>
          <span class="dots">...</span>
        `;

        botMessageWrapper.appendChild(botMsg);

        const sourceEl = document.createElement("div");
        sourceEl.className = "source-info text-muted small mt-2 fa-num";
        sourceEl.style.display = "none";
        botMessageWrapper.appendChild(sourceEl);

        chatContainer.appendChild(botMessageWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ù‚Ø·Ù‡â€ŒÙ‡Ø§
        let dotCount = 0;
        let dotInterval = setInterval(() => {
          dotCount = (dotCount + 1) % 4;
          const dotsEl = botMsg.querySelector(".dots");
          if (dotsEl) dotsEl.textContent = ".".repeat(dotCount);
        }, 400);

        messageInput.value = "";

        let fullResponse = "";
        let attempts = 0;
        const maxAttempts = 3;

        while (attempts < maxAttempts) {
          attempts++;
          try {
            const res = await fetch("/api/rag/chat-message", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_key: userKey,
                message,
                chat_id: currentChatId,
              }),
            });

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || "Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±");
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            fullResponse = "";
            botMsg.innerHTML = "";

            let streamCompleted = false;
            while (true) {
              const { done, value } = await reader.read();
              if (done) {
                streamCompleted = true;
                break;
              }

              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk
                .split("\n")
                .filter((l) => l.startsWith("data: "));

              for (const line of lines) {
                if (line === "data: [DONE]") continue;
                try {
                  const json = JSON.parse(line.slice(6));
                  const token = json.choices[0].delta.content || "";
                  fullResponse += token;

                  const safeResponse = fullResponse
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                  botMsg.innerHTML = marked.parse(safeResponse);
                  updateDirection(botMsg, fullResponse);
                  chatContainer.scrollTop = chatContainer.scrollHeight;
                } catch (e) {
                  // Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¬Ø²Ø¦ÛŒ JSON
                }
              }
            }

            if (streamCompleted) {
              // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø§Ø³Ø®: Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ù…Ù†Ø¨Ø¹
              let mainAnswer = fullResponse.trim();
              let sourceText = "";

              const patterns = [
                /\n\n?\*\*?Ù…Ù†Ø§Ø¨Ø¹?\*\*?[:ï¼š]\s*([\s\S]*)$/i,
                /\n---\n[\s\S]*$/i,
                /\n\nÙ…Ù†Ø¨Ø¹[:Ø›]\s*([\s\S]*)$/i,
                /\n\*\*Ù…Ù†Ø¨Ø¹\*\*[:Ø›]\s*([\s\S]*)$/i,
                /Ù…Ù†Ø¨Ø¹[:Ø›]\s*Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø¯Ù„\s*$/i,
                /Ù…Ù†Ø¨Ø¹\s*:\s*Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø¯Ù„\s*$/i,
                /Ù…Ù†Ø§Ø¨Ø¹\s*:\s*Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø¯Ù„\s*$/i,
              ];

              let matched = false;
              for (const pattern of patterns) {
                const match = mainAnswer.match(pattern);
                if (match) {
                  sourceText = (match[1] || match[0]).trim();
                  mainAnswer = mainAnswer.replace(match[0], "").trim();
                  matched = true;
                  break;
                }
              }

              if (!matched || /Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ/i.test(sourceText)) {
                sourceText = "Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø¯Ù„";
              } else {
                sourceText = sourceText
                  .replace(/^\d+\.\s*/gm, "")
                  .replace(/Ù…Ù†Ø¨Ø¹ \d+[:ï¼š]\s*/gi, "")
                  .split("\n")
                  .map((s) => s.trim())
                  .filter((s) => s && !/Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ/i.test(s))
                  .join("ØŒ ");
              }

              // Ù†Ù…Ø§ÛŒØ´ Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø§Ø³Ø® Ùˆ Ù…Ù†Ø¨Ø¹
              const finalSafe = mainAnswer
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
              botMsg.innerHTML = marked.parse(finalSafe || fullResponse);

              if (sourceText === "Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø¯Ù„") {
                sourceEl.innerHTML = `<em style="color:#94a3b8;">Ù…Ù†Ø¨Ø¹: Ø¯Ø§Ù†Ø´ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø¯Ù„</em>`;
              } else if (sourceText) {
                sourceEl.innerHTML = `
            <div style="margin-top:8px;padding:8px 12px;background:#f1f5f9;border-radius:8px;font-size:0.9em;color:#475569;">
              <strong>Ù…Ù†Ø§Ø¨Ø¹:</strong> ${escapeHtml(sourceText)}
            </div>`;
              }
              sourceEl.style.display = "block";

              // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±
              chatHistory.push({ role: "user", content: message });
              chatHistory.push({
                role: "assistant",
                content: mainAnswer || fullResponse,
              });

              // ØªÙˆÙ„ÛŒØ¯ Ø¹Ù†ÙˆØ§Ù† Ú†Øª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù…
              if (chatHistory.length === 2) {
                await generateChatTitle(message);
              }

              // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù…
              if (currentChatId) {
                fetch("/api/rag/chat", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    user_key: userKey,
                    chat_id: currentChatId,
                  }),
                });
              }
              clearInterval(dotInterval);
              messageInput.disabled = false;
              sendBtn.disabled = false;
              return;
            }
          } catch (err) {
            console.warn(`ØªÙ„Ø§Ø´ ${attempts} Ù†Ø§Ù…ÙˆÙÙ‚:`, err);
            if (attempts < maxAttempts) {
              toast(
                `Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯ØŒ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ ${attempts + 1} Ø§Ø² ${maxAttempts}...`,
                "warning"
              );
              fullResponse = "";
              botMsg.innerHTML = "";
              botMsg.innerHTML = `
                <span class="thinking">Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</span>
                <span class="dots">...</span>
              `;
              // Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
              dotCount = 0;
              clearInterval(dotInterval);
              dotInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                const dotsEl = botMsg.querySelector(".dots");
                if (dotsEl) dotsEl.textContent = ".".repeat(dotCount);
              }, 400);
              await new Promise((resolve) => setTimeout(resolve, 1500));
            }
          }
        }

        clearInterval(dotInterval);
        botMsg.innerHTML = marked.parse(
          "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ù¾Ø³ Ø§Ø² Ú†Ù†Ø¯ ØªÙ„Ø§Ø´. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯."
        );
        toast("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±", "danger");
        messageInput.disabled = false;
        sendBtn.disabled = false;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      uploadInput.addEventListener("change", async (e) => {
        const loadingModal = showLoadingModal(
          "Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯"
        );

        let files = Array.from(e.target.files);
        if (files.length === 0) return;

        // Client-side type validation
        const allowedTypes = [
          "application/pdf",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          "text/plain",
        ];
        files = files.filter((file) => {
          if (!allowedTypes.includes(file.type)) {
            toast(
              `ÙØ§ÛŒÙ„ "${file.name}" Ù†ÙˆØ¹ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª (ÙÙ‚Ø· PDF, DOCX, TXT)`,
              "danger"
            );
            return false;
          }
          return true;
        });

        if (files.length === 0) {
          hideLoadingModal();
          return;
        }

        for (const file of files) {
          if (file.size > 200 * 1024 * 1024) {
            toast(`ÙØ§ÛŒÙ„ "${file.name}" Ø¨ÛŒØ´ Ø§Ø² Û²Û°Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø§Ø³Øª`, "danger");
            continue;
          }

          const formData = new FormData();
          formData.append("file", file);
          formData.append("user_key", userKey);

          try {
            const res = await fetch("/api/rag/upload", {
              method: "POST",
              body: formData,
            });

            if (!res.ok) {
              const error = await res.json();
              toast(error.error || "Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯", "danger");
              continue;
            }

            toast(`ÙØ§ÛŒÙ„ "${file.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯`, "success");
          } catch (err) {
            console.error(err);
            toast(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ ${file.name}`, "danger");
            hideLoadingModal();
            return;
          }
          // Simple batching: small delay to avoid overload
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        hideLoadingModal();
        loadFiles();
        uploadInput.value = "";
      });

      async function generateChatTitle(firstMessage) {
        const cacheKey = `${currentChatId}-${firstMessage.substring(0, 100)}`;
        if (titleCache.has(cacheKey)) {
          const cachedTitle = titleCache.get(cacheKey);
          if (cachedTitle && cachedTitle.trim() !== "Ú†Øª Ø¬Ø¯ÛŒØ¯") {
            currentChatTitle.innerHTML =
              cachedTitle.trim() +
              `<small class="text-muted ms-2" style="font-size: 0.5em;">(Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</small>`;
            return;
          }
        }
        try {
          const res = await fetch("/api/rag/generate-title", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_key: userKey,
              chat_id: currentChatId,
              first_message: firstMessage,
            }),
          });

          if (res.ok) {
            const { title } = await res.json();
            titleCache.set(cacheKey, title);
            if (title && title.trim() && title.trim() !== "Ú†Øª Ø¬Ø¯ÛŒØ¯") {
              currentChatTitle.innerHTML =
                title.trim() +
                `<small class="text-muted ms-2" style="font-size: 0.5em;">(Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</small>`;
              loadChats();
            }
          }
        } catch (err) {
          console.error("Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø¹Ù†ÙˆØ§Ù†:", err);
        }
      }
      async function deleteFile(fileId, fileName, event) {
        event.stopPropagation();

        const confirmed = await confirmDialog({
          title: "Ø­Ø°Ù ÙØ§ÛŒÙ„",
          message: `Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù ÙØ§ÛŒÙ„ Â«${fileName}Â» Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`,
          confirmText: "Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†",
          confirmClass: "btn-danger",
        });

        if (!confirmed) return;

        const res = await fetch(`/api/rag/file/${fileId}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_key: userKey }),
        });

        if (res.ok) {
          toast(`ÙØ§ÛŒÙ„ "${fileName}" Ø­Ø°Ù Ø´Ø¯`, "info");
          loadFiles();
        } else {
          toast("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙØ§ÛŒÙ„", "danger");
        }
      }

      deleteAllFilesBtn.addEventListener("click", async () => {
        const confirmed = await confirmDialog({
          title: "Ø­Ø°Ù Ù‡Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§",
          message:
            "Ù‡Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯Ø´Ø¯Ù‡ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÛŒØ± Ø§Ø³Øª!",
          confirmText: "Ø¨Ù„Ù‡ØŒ Ù‡Ù…Ù‡ Ø±Ø§ Ø­Ø°Ù Ú©Ù†",
          confirmClass: "btn-danger",
        });

        if (!confirmed) return;

        const res = await fetch("/api/rag/files", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_key: userKey }),
        });

        if (res.ok) {
          toast("Ù‡Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯", "info");
          loadFiles();
        }
      });

      async function deleteChat(chatId, event) {
        event.stopPropagation();

        const confirmed = await confirmDialog({
          title: "Ø­Ø°Ù Ú†Øª",
          message: "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú†Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ",
          confirmText: "Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†",
          confirmClass: "btn-danger",
        });

        if (!confirmed) return;

        const res = await fetch(`/api/rag/chat/${chatId}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_key: userKey }),
        });

        if (res.ok) {
          toast("Ú†Øª Ø­Ø°Ù Ø´Ø¯", "info");
          loadChats();
          if (currentChatId === chatId) {
            currentChatId = null;
            chatContainer.innerHTML = "";
            currentChatTitle.textContent = "Ú†Øª Ø¬Ø¯ÛŒØ¯";
          }
        }
      }

      deleteAllChatsBtn.addEventListener("click", async () => {
        const confirmed = await confirmDialog({
          title: "Ø­Ø°Ù Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§",
          message: "Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ",
          confirmText: "Ø¨Ù„Ù‡ØŒ Ù‡Ù…Ù‡ Ø±Ø§ Ø­Ø°Ù Ú©Ù†",
          confirmClass: "btn-danger",
        });

        if (!confirmed) return;

        const res = await fetch("/api/rag/chats", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_key: userKey }),
        });

        if (res.ok) {
          toast("Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯", "info");
          loadChats();
          currentChatId = null;
          chatContainer.innerHTML = "";
          currentChatTitle.textContent = "Ú†Øª Ø¬Ø¯ÛŒØ¯";
        }
      });

      newChatBtn.addEventListener("click", async () => {
        const res = await fetch("/api/rag/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_key: userKey }),
        });
        const { chat_id } = await res.json();
        currentChatId = chat_id;
        chatHistory = [];
        chatContainer.innerHTML = "";
        currentChatTitle.textContent = "Ú†Øª Ø¬Ø¯ÛŒØ¯";
        loadChats();
      });

      // Event listeners
      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
      backToLogin.addEventListener("click", async () => {
        const confirmed = await confirmDialog({
          title: "Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨",
          message: "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ",
          confirmText: "Ø¨Ù„Ù‡ØŒ Ø®Ø§Ø±Ø¬ Ø´Ùˆ",
          confirmClass: "btn-outline-danger",
        });

        if (confirmed) {
          sessionStorage.removeItem("user_key");
          window.location.href = "/login.html";
        }
      });

      loadChats();
      loadFiles();
      if (currentChatId) loadChat(currentChatId);
    </script>
  </body>
</html>
